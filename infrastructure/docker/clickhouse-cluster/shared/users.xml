<?xml version="1.0"?>
<!--
    ClickHouse Users Configuration для ЕГРЮЛ/ЕГРИП
-->
<clickhouse>
    <!-- Профили настроек -->
    <profiles>
        <!-- Профиль по умолчанию -->
        <default>
            <max_memory_usage>10000000000</max_memory_usage>
            <max_execution_time>300</max_execution_time>
            <max_threads>8</max_threads>
            <max_block_size>65536</max_block_size>
            <use_uncompressed_cache>1</use_uncompressed_cache>
            <load_balancing>random</load_balancing>
            
            <!-- Оптимизации для аналитических запросов -->
            <optimize_move_to_prewhere>1</optimize_move_to_prewhere>
            <optimize_aggregation_in_order>1</optimize_aggregation_in_order>
            <compile_expressions>1</compile_expressions>
            <min_count_to_compile_expression>3</min_count_to_compile_expression>
            
            <!-- Join оптимизации -->
            <join_algorithm>auto</join_algorithm>
            <partial_merge_join_optimizations>1</partial_merge_join_optimizations>
        </default>

        <!-- Профиль для импорта данных -->
        <import_profile>
            <max_memory_usage>20000000000</max_memory_usage>
            <max_execution_time>3600</max_execution_time>
            <max_threads>16</max_threads>
            <max_insert_threads>16</max_insert_threads>
            <max_block_size>1048576</max_block_size>
            
            <!-- Настройки для массовой вставки -->
            <async_insert>1</async_insert>
            <wait_for_async_insert>1</wait_for_async_insert>
            <async_insert_max_data_size>10000000</async_insert_max_data_size>
            <async_insert_busy_timeout_ms>200</async_insert_busy_timeout_ms>
            
            <!-- Отключаем некоторые проверки для ускорения импорта -->
            <input_format_allow_errors_num>1000</input_format_allow_errors_num>
            <input_format_allow_errors_ratio>0.01</input_format_allow_errors_ratio>
        </import_profile>

        <!-- Профиль только для чтения -->
        <readonly>
            <readonly>1</readonly>
            <max_memory_usage>5000000000</max_memory_usage>
            <max_execution_time>60</max_execution_time>
            <max_threads>4</max_threads>
        </readonly>

        <!-- Профиль для аналитики -->
        <analytics>
            <max_memory_usage>15000000000</max_memory_usage>
            <max_execution_time>600</max_execution_time>
            <max_threads>16</max_threads>
            <use_uncompressed_cache>1</use_uncompressed_cache>
            
            <!-- Агрессивная оптимизация для сложных запросов -->
            <optimize_aggregation_in_order>1</optimize_aggregation_in_order>
            <optimize_read_in_order>1</optimize_read_in_order>
            <compile_aggregate_expressions>1</compile_aggregate_expressions>
            
            <!-- Параллельная обработка -->
            <max_bytes_before_external_group_by>10000000000</max_bytes_before_external_group_by>
            <max_bytes_before_external_sort>10000000000</max_bytes_before_external_sort>
        </analytics>
    </profiles>

    <!-- Пользователи -->
    <!-- ВАЖНО: Пользователь admin создается автоматически через переменные окружения -->
    <!-- CLICKHOUSE_USER и CLICKHOUSE_PASSWORD в docker-compose.yml -->
    <users>
        <!-- Пользователь для приложения -->
        <egrul_app>
            <password_sha256_hex>9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08</password_sha256_hex>
            <!-- Пароль: test (замените в production!) -->
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>default</profile>
            <quota>default</quota>
            <databases>
                <egrul>
                    <companies>
                        <filter/>
                    </companies>
                    <entrepreneurs>
                        <filter/>
                    </entrepreneurs>
                    <company_history>
                        <filter/>
                    </company_history>
                    <ownership_graph>
                        <filter/>
                    </ownership_graph>
                </egrul>
            </databases>
        </egrul_app>

        <!-- Пользователь для импорта данных -->
        <egrul_import>
            <password_sha256_hex>a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3</password_sha256_hex>
            <!-- Пароль: 123 (замените в production!) -->
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>import_profile</profile>
            <quota>default</quota>
            <!-- Полный доступ к базе egrul -->
            <access_management>1</access_management>
        </egrul_import>

        <!-- Пользователь только для чтения (для аналитики) -->
        <egrul_reader>
            <password_sha256_hex>5e884898da28047d9191e6e0c3e4c8f1e4c7c8e8eac58d7ca45ff29e3d0a3b75</password_sha256_hex>
            <!-- Пароль: password (замените в production!) -->
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>readonly</profile>
            <quota>default</quota>
        </egrul_reader>

        <!-- Пользователь для API (с оптимизациями для аналитики) -->
        <egrul_api>
            <password_sha256_hex>ef92b778bafe771e89245b89ecbc08a44a4e166c06659911881f383d4473e94f</password_sha256_hex>
            <!-- Пароль: password123 (замените в production!) -->
            <networks>
                <ip>::/0</ip>
            </networks>
            <profile>analytics</profile>
            <quota>default</quota>
        </egrul_api>

        <!-- Пользователь по умолчанию (без пароля, только для локальных подключений) -->
        <default>
            <password></password>
            <networks>
                <ip>127.0.0.1</ip>
                <ip>::1</ip>
            </networks>
            <profile>default</profile>
            <quota>default</quota>
        </default>
    </users>

    <!-- Квоты -->
    <quotas>
        <default>
            <interval>
                <duration>3600</duration>
                <queries>0</queries>
                <errors>0</errors>
                <result_rows>0</result_rows>
                <read_rows>0</read_rows>
                <execution_time>0</execution_time>
            </interval>
        </default>

        <!-- Квота для API с лимитами -->
        <api_quota>
            <interval>
                <duration>3600</duration>
                <queries>10000</queries>
                <errors>100</errors>
                <result_rows>100000000</result_rows>
                <read_rows>1000000000</read_rows>
                <execution_time>36000</execution_time>
            </interval>
        </api_quota>
    </quotas>
</clickhouse>

