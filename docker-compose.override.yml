# ==============================================================================
# Development Overrides - docker-compose.override.yml
# ==============================================================================
# Этот файл автоматически применяется при запуске `docker compose up`
# Содержит настройки для локальной разработки: hot reload, volume mounts, debug
# ==============================================================================

services:
  # Frontend - hot reload для быстрой разработки
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      target: builder  # Останавливаемся на builder stage
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080/api/v1}
        - NEXT_PUBLIC_GRAPHQL_URL=${NEXT_PUBLIC_GRAPHQL_URL:-http://localhost:8080/graphql}
        - NEXT_PUBLIC_YANDEX_MAPS_API_KEY=${NEXT_PUBLIC_YANDEX_MAPS_API_KEY:-}
        - NEXT_PUBLIC_DEBUG=${NEXT_PUBLIC_DEBUG:-true}
    command: pnpm dev
    volumes:
      - ./frontend:/app:cached
      - /app/node_modules
      - /app/.next
    environment:
      - NODE_ENV=development
      - WATCHPACK_POLLING=true  # Для Docker на Mac/Windows
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8080/api/v1}
      - NEXT_PUBLIC_GRAPHQL_URL=${NEXT_PUBLIC_GRAPHQL_URL:-http://localhost:8080/graphql}
      - NEXT_PUBLIC_YANDEX_MAPS_API_KEY=${NEXT_PUBLIC_YANDEX_MAPS_API_KEY:-}
      - NEXT_PUBLIC_DEBUG=true
    ports:
      - "3000:3000"

  # API Gateway - volume mounts для live code reload
  api-gateway:
    build:
      context: .
      dockerfile: services/api-gateway/Dockerfile
      target: builder  # Останавливаемся на builder stage для dev
    volumes:
      - ./services/api-gateway:/app:cached
      - /app/bin
      - ./.cursor:/app/.cursor:rw
    ports:
      - "8080:8080"
      - "2345:2345"  # Delve debugger port
    environment:
      - LOG_LEVEL=debug
      - DEBUG_LOG_PATH=/app/.cursor/debug.log
      - GRAPHQL_PLAYGROUND_ENABLED=true

  # Search Service - volume mounts для dev
  search-service:
    build:
      context: .
      dockerfile: services/search-service/Dockerfile
      target: builder
    volumes:
      - ./services/search-service:/app:cached
      - /app/bin
    environment:
      - LOG_LEVEL=debug

  # Parser - сервис для разработки парсера
  parser:
    build:
      context: .
      dockerfile: infrastructure/docker/parser/Dockerfile
    container_name: egrul-parser
    volumes:
      - ./test:/data/input:ro
      - ./output:/data/output:rw
    networks:
      - egrul-network
    profiles:
      - parser
