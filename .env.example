# ==============================================================================
# ЕГРЮЛ/ЕГРИП System - Environment Variables Template
# ==============================================================================
# Скопируйте этот файл в .env и измените значения согласно вашему окружению
# cp .env.example .env
# ==============================================================================

# ==============================================================================
# PostgreSQL
# ==============================================================================
POSTGRES_HOST=postgres
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=postgres
# ВАЖНО: Измените пароль в production!
POSTGRES_DB=egrul

# ==============================================================================
# ClickHouse - Основное аналитическое хранилище
# ==============================================================================
CLICKHOUSE_HOST=clickhouse
CLICKHOUSE_HTTP_PORT=8123
CLICKHOUSE_NATIVE_PORT=9000
CLICKHOUSE_INTERSERVER_PORT=9009
CLICKHOUSE_USER=egrul_app
CLICKHOUSE_PASSWORD=test
# ВАЖНО: Измените пароль в production!
CLICKHOUSE_DB=egrul
CLICKHOUSE_DATABASE=egrul
# Лимит памяти для ClickHouse (16G для dev, 32G для prod)
CLICKHOUSE_MEMORY_LIMIT=16G
# Default access management
CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1

# ==============================================================================
# Elasticsearch - Полнотекстовый поиск
# ==============================================================================
ELASTICSEARCH_HOST=elasticsearch
ELASTICSEARCH_PORT=9200
ELASTICSEARCH_URL=http://elasticsearch:9200
# Java heap size для Elasticsearch (512m для dev, 2g для prod)
ES_JAVA_OPTS=-Xms512m -Xmx512m

# ==============================================================================
# Elasticsearch Sync Service - Синхронизация данных ClickHouse → Elasticsearch
# ==============================================================================
# Режим синхронизации: initial (полная загрузка), incremental (только изменения), daemon (периодическая синхронизация)
SYNC_MODE=incremental
# Размер батча для обработки при initial sync (количество записей за один раз)
SYNC_BATCH_SIZE=10000
# Интервал для daemon mode (5m = 5 минут)
SYNC_INTERVAL=5m
# Redis key для хранения timestamp последней синхронизации
SYNC_LAST_TIMESTAMP_KEY=es:last_sync

# ==============================================================================
# Elasticsearch Search - Настройки поиска
# ==============================================================================
# Выбор движка поиска: clickhouse (только ClickHouse), elasticsearch (только ES), hybrid (умный выбор)
SEARCH_ENGINE=hybrid
# Максимальное количество результатов из Elasticsearch
ES_MAX_RESULTS=10000
# Таймаут запросов к Elasticsearch (30s = 30 секунд)
ES_TIMEOUT=30s
# Fallback на ClickHouse при ошибках Elasticsearch
ES_FALLBACK_TO_CH=true

# ==============================================================================
# Redis - Кэширование и сессии
# ==============================================================================
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=
# Оставьте пустым если не требуется аутентификация

# ==============================================================================
# Kafka - Event Streaming (для profile: full)
# ==============================================================================
KAFKA_BROKER=kafka:9092
KAFKA_EXTERNAL_BROKER=localhost:29092
KAFKA_ZOOKEEPER=zookeeper:2181
KAFKA_BROKER_ID=1
# Java heap size для Kafka (512m для dev, 1g для prod)
KAFKA_HEAP_OPTS=-Xms512m -Xmx512m
# Автоматическое создание топиков
KAFKA_AUTO_CREATE_TOPICS=true
KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR=1

# ==============================================================================
# Zookeeper - Координация для Kafka (для profile: full)
# Избегаем конфликта с ClickHouse Keeper (порты 2181-2183)
# ==============================================================================
ZOOKEEPER_EXTERNAL_PORT=2184
ZOOKEEPER_TICK_TIME=2000

# ==============================================================================
# MinIO - S3-совместимое объектное хранилище (для profile: full)
# ==============================================================================
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin
# ВАЖНО: Измените учетные данные в production!
MINIO_API_PORT=9022
MINIO_CONSOLE_PORT=9021
MINIO_DOMAIN=minio
# Buckets создаются автоматически: xml-files, parquet-files, backups

# ==============================================================================
# API Gateway - GraphQL/REST API
# ==============================================================================
API_GATEWAY_PORT=8080
# Logging
LOG_LEVEL=info
# Доступные уровни: debug, info, warn, error
LOG_FORMAT=json
# Форматы: json, text
# GraphQL настройки
GRAPHQL_PLAYGROUND_ENABLED=true
GRAPHQL_INTROSPECTION_ENABLED=true
# Отключите в production для безопасности
# Debug logging
DEBUG_LOG_PATH=/app/.cursor/debug.log

# ==============================================================================
# Search Service - Поисковый сервис
# ==============================================================================
SEARCH_SERVICE_PORT=8081

# ==============================================================================
# Frontend - Next.js UI
# ==============================================================================
FRONTEND_PORT=3000
# Public API URLs (доступны в браузере)
NEXT_PUBLIC_API_URL=http://localhost:8080/api/v1
NEXT_PUBLIC_GRAPHQL_URL=http://localhost:8080/graphql
NEXT_PUBLIC_YANDEX_MAPS_API_KEY=
# Получите ключ на https://developer.tech.yandex.ru/services
NODE_ENV=development
# Окружение: development, production
NEXT_PUBLIC_DEBUG=false
# Включить debug режим во фронтенде
# Hot reload для Docker на Mac/Windows
WATCHPACK_POLLING=true

# ==============================================================================
# Adminer - Web UI для PostgreSQL (для profile: tools, full)
# ==============================================================================
ADMINER_PORT=8090
ADMINER_DESIGN=pepa-linha
# Доступные темы: pepa-linha, nette, nette-dark, mvt

# ==============================================================================
# RedisInsight - Web UI для Redis (для profile: tools, full)
# ==============================================================================
REDISINSIGHT_PORT=8091

# ==============================================================================
# Grafana - Мониторинг (для profile: monitoring)
# ==============================================================================
GRAFANA_PORT=3001
GF_SECURITY_ADMIN_USER=admin
GF_SECURITY_ADMIN_PASSWORD=admin
# ВАЖНО: Измените пароль в production!
GF_INSTALL_PLUGINS=grafana-clickhouse-datasource

# ==============================================================================
# Data Import - Настройки импорта данных
# ==============================================================================
DATA_DIR=./output
# Директория с Parquet файлами для импорта

# Настройки памяти для батчей истории изменений
# Лимит памяти в байтах (10GB по умолчанию)
HISTORY_MAX_MEMORY=10000000000
# Количество батчей для параллельной обработки
HISTORY_BUCKETS=10

# Автоматическое детектирование изменений после импорта
# Если true, автоматически запускает change-detection-service для обнаружения изменений
AUTO_DETECT_CHANGES=true

# Автоматическая очистка старых версий после детектирования
# Если true, запускает OPTIMIZE TABLE FINAL после детектирования изменений
# ВАЖНО: Удаляет старые версии и дубли из БД (история теряется)
# Рекомендуется: false (очистка вручную через make cluster-optimize)
AUTO_OPTIMIZE_AFTER_DETECT=false

# Принудительная оптимизация сразу после импорта (устаревшее)
# НЕ рекомендуется использовать вместе с AUTO_OPTIMIZE_AFTER_DETECT
# Лучше использовать AUTO_OPTIMIZE_AFTER_DETECT=true
OPTIMIZE_AFTER_IMPORT=false

# ==============================================================================
# Parser - Rust парсер XML (для profile: parser)
# ==============================================================================
PARSER_INPUT=/data/input
PARSER_OUTPUT=/data/output
PARSER_WORKERS=
# Оставьте пустым для автоопределения по количеству CPU
PARSER_BATCH_SIZE=5000
PARSER_CHANNEL_BUFFER_SIZE=10000
PARSER_COMPRESSION=snappy
# Варианты: snappy, gzip, zstd, lz4, none

# ==============================================================================
# Docker Compose настройки
# ==============================================================================
COMPOSE_PROJECT_NAME=egrul
# Префикс для всех контейнеров и volumes
COMPOSE_FILE=docker-compose.yml
# Можно добавить: docker-compose.override.yml для dev

# ==============================================================================
# Network & Resource Limits (для docker-compose.prod.yml)
# ==============================================================================
# PostgreSQL
POSTGRES_CPU_LIMIT=2
POSTGRES_MEMORY_LIMIT=4G
POSTGRES_MEMORY_RESERVATION=2G

# ClickHouse
CLICKHOUSE_CPU_LIMIT=8
CLICKHOUSE_MEMORY_LIMIT_PROD=32G
CLICKHOUSE_MEMORY_RESERVATION=16G
CLICKHOUSE_ULIMIT_NOFILE=524288

# Elasticsearch
ELASTICSEARCH_CPU_LIMIT=4
ELASTICSEARCH_MEMORY_LIMIT=8G
ELASTICSEARCH_MEMORY_RESERVATION=4G

# Redis
REDIS_MEMORY_LIMIT=1G
REDIS_MEMORY_RESERVATION=512M

# Kafka
KAFKA_CPU_LIMIT=2
KAFKA_MEMORY_LIMIT=2G
KAFKA_MEMORY_RESERVATION=1G

# MinIO
MINIO_CPU_LIMIT=2
MINIO_MEMORY_LIMIT=2G
MINIO_MEMORY_RESERVATION=1G

# API Gateway
API_GATEWAY_CPU_LIMIT=2
API_GATEWAY_MEMORY_LIMIT=2G
API_GATEWAY_MEMORY_RESERVATION=1G

# Frontend
FRONTEND_CPU_LIMIT=2
FRONTEND_MEMORY_LIMIT=1G
FRONTEND_MEMORY_RESERVATION=512M

# ==============================================================================
# Change Detection & Notification Services
# ==============================================================================

# Change Detection Service
CHANGE_DETECTION_SERVICE_PORT=8082
CHANGE_DETECTION_SERVICE_LOG_LEVEL=info

# Notification Service
NOTIFICATION_SERVICE_PORT=8083
NOTIFICATION_SERVICE_LOG_LEVEL=info

# ==============================================================================
# SMTP Configuration (для Email уведомлений)
# ==============================================================================

# Корпоративный SMTP сервер (production)
SMTP_HOST=smtp.company.ru
SMTP_PORT=587
SMTP_USERNAME=notifications@company.ru
SMTP_PASSWORD=CHANGE_ME_IN_SECRETS
SMTP_FROM=noreply@egrul.company.ru
SMTP_FROM_NAME=ЕГРЮЛ/ЕГРИП Мониторинг
SMTP_TLS=true

# DRY RUN режим (для тестирования подписок)
# Если true, email не отправляются, только логируются
# Для dev/testing используйте true, для production используйте false
EMAIL_DRY_RUN=false

# ==============================================================================
# Kafka Topics Configuration (для событий изменений)
# ==============================================================================

KAFKA_BROKERS=kafka:9092
KAFKA_COMPANY_CHANGES_TOPIC=company-changes
KAFKA_ENTREPRENEUR_CHANGES_TOPIC=entrepreneur-changes
KAFKA_CONSUMER_GROUP=notification-service-group
KAFKA_PARTITION_COUNT=3
KAFKA_REPLICATION_FACTOR=1

# ==============================================================================
# PostgreSQL для subscriptions
# ==============================================================================

POSTGRES_SUBSCRIPTION_SCHEMA=subscriptions

# ==============================================================================
# Resource Limits для новых сервисов
# ==============================================================================

# Change Detection Service
CHANGE_DETECTION_CPU_LIMIT=2
CHANGE_DETECTION_MEMORY_LIMIT=2G
CHANGE_DETECTION_MEMORY_RESERVATION=1G

# Notification Service
NOTIFICATION_CPU_LIMIT=2
NOTIFICATION_MEMORY_LIMIT=2G
NOTIFICATION_MEMORY_RESERVATION=1G
